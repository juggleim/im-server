import{M as N,N as q,aa as Z,e as r,r as A,H as G,o as m,B as tt,w as V,b as t,p as D,C as et,u as o,c as f,d as I,t as d,F as B,k as M,v as S,_ as st,h as H,a6 as U,q as L,l as ot,R as O,x as at,ab as R}from"./index-668b837b.js";function lt(h){let{limit:y=15,offset:v=1,app_key:u,user_id:b,start:e,end:p,description:k}=h,$=`${N.LOG_GET_LIST}?app_key=${u}&user_id=${b}&limit=${y}&offset=${v}&start=${e}&end=${p}&description=${k}`;return q($,{method:"GET"})}function nt(h){let{app_key:y,id:v}=h,u=`${N.LOG_DOWNLOAD}?app_key=${y}&id=${v}`;return Z(u,{method:"GET"})}function it(h){return q(N.LOG_CREATE_PULL,{method:"POST",body:r.toJSON(h)})}const P={getList:lt,create:it,download:nt},rt={class:"row g-2 cim-row cim-dialog-pull-row"},dt={class:"form-floating"},ct=["value"],mt={class:"form-floating cim-dialog-pull-datetime"},ut=["onClick"],pt={class:"form-floating cim-from-must cicon cicon-must"},ft={class:"form-floating cim-from-must cicon cicon-must"},_t={__name:"dialog-pull-log",props:["title","text"],emits:["save","hide"],setup(h,{emit:y}){const v=H(),u=h,b=y;let e=A({params:{user_id:"",description:"",platform:"Android"},range:{start:new Date(Date.now()-1*24*60*60*1e3),end:new Date},times:[{value:"1"}],categories:[{name:"业务日志",value:1}],platforms:[{name:"Android",value:"Android"},{name:"iOS",value:"iOS"},{name:"Web",value:"Web"},{name:"PC",value:"PC"}]});function p(){let{user_id:_,description:l}=e.params;if(r.isEqual(_.length,0))return v.proxy.$toast({icon:"error",text:"用户 ID 不可为空"});if(r.isEqual(l.length,0))return v.proxy.$toast({icon:"error",text:"备注 不可为空"});let x=r.clone(e.params),{start:n,end:w}=e.range;b("save",{...x,start:n.getTime(),end:w.getTime()})}function k(_){b("hide",{})}function $(_){return r.formatTime(new Date(_).getTime(),"yyyy-MM-dd hh:mm")}return(_,l)=>{const x=G("VDatePicker");return m(),tt(st,{title:u.title,"btn-title":u.text,cls:"cim-pull-dialog",onHide:k,onSave:p},{default:V(()=>[t("div",rt,[t("div",dt,[D(t("select",{class:"form-select","onUpdate:modelValue":l[0]||(l[0]=n=>o(e).params.platform=n)},[(m(!0),f(B,null,I(o(e).platforms,n=>(m(),f("option",{value:n.value},d(n.name),9,ct))),256))],512),[[et,o(e).params.platform]]),l[4]||(l[4]=t("label",null,"平台",-1))]),t("div",mt,[M(x,{modelValue:o(e).range,"onUpdate:modelValue":l[1]||(l[1]=n=>o(e).range=n),modelModifiers:{range:!0},mode:"dateTime",is24hr:""},{default:V(({togglePopover:n})=>[t("div",{class:"form-control cim-as-date-content",onClick:n},d($(o(e).range.start))+" 至 "+d($(o(e).range.end)),9,ut)]),_:1},8,["modelValue"]),l[5]||(l[5]=t("label",null,"时间范围",-1))]),t("div",pt,[D(t("input",{class:"form-control",placeholder:"用户 ID","onUpdate:modelValue":l[2]||(l[2]=n=>o(e).params.user_id=n)},null,512),[[S,o(e).params.user_id]]),l[6]||(l[6]=t("label",null,"用户 ID ",-1))]),t("div",ft,[D(t("input",{class:"form-control",placeholder:"备注说明","onUpdate:modelValue":l[3]||(l[3]=n=>o(e).params.description=n)},null,512),[[S,o(e).params.description]]),l[7]||(l[7]=t("label",null,"备注说明",-1))])])]),_:1},8,["title","btn-title"])}}},gt={class:"mb-4 cim-log-contanier"},ht={class:"cim-log-header"},yt={class:"cim-log-header-lf-box"},vt={class:"cim-log-lf-item"},bt=["onClick"],kt={class:"cim-log-lf-item"},wt={class:"cim-log-lf-item"},$t={class:"cim-log-header-rg-box"},xt={class:"cim-log-lf-item"},Dt={class:"cim-log-body"},Ct={class:"table cim-table"},St={class:"cim-td-c"},Et={class:"cim-td-c"},Tt={class:"cim-td-c"},Lt={class:"cim-td-c"},Pt={class:"cim-td-c"},Vt={class:"cim-td-c"},Mt={class:"cim-td-c"},Nt={class:"cim-table-tools"},Ut={key:0,class:"cim-table-tool"},Ot=["href"],Rt=["onClick"],qt={class:"cim-log-footer"},At={class:"cim-navigation"},Gt={class:"pagination"},It={key:0,class:"page-item"},Bt={class:"page-item"},Ft={__name:"list",setup(h){const y=H();let v=ot(),{currentRoute:{_rawValue:{params:{app_key:u}}}}=v,b={offset:1,limit:50,app_key:u,user_id:"",description:""},e=A({isShowPullDialog:!1,params:r.clone(b),list:[],range:{start:new Date(Date.now()-1*24*60*60*1e3),end:new Date(Date.now()+1*24*60*60*1e3)}});function p(i,a="yyyy-MM-dd"){return r.formatTime(new Date(i).getTime(),a)}function k(i){e.isShowPullDialog=i}function $(i){let a={...i,app_key:u};P.create(a).then(g=>{let{code:s,msg:c}=g;r.isEqual(s,O.SUCCESS)?(r.extend(e.params,r.clone(b)),k(!1),w()):y.proxy.$toast({icon:"error",text:`Error: ${s} ${c}`})})}function _(){w()}function l(){let{offset:i}=e.params;i+=1,r.extend(e.params,{offset:i}),w()}function x(){let{offset:i}=e.params;i-=1,r.extend(e.params,{offset:i}),w()}function n(i){P.download({id:i.id,app_key:u}).then(g=>{a(g,`imlog-${p(Date.now(),"yyyyMMddhhmmss")}.txt`)});function a(g,s){const c=document.createElement("a");c.download=s;const C=URL.createObjectURL(g);c.href=C,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(C)}}function w(){let{start:i,end:a}=e.range,g={...e.params,start:i.getTime(),end:a.getTime()};P.getList(g).then(s=>{let{code:c,data:C,msg:F=""}=s;if(r.isEqual(c,O.SUCCESS)){let{items:E}=C;E=r.map(E,T=>{let{created_time:K,start:W,end:j,state:z}=T,J=R[z],Q=p(W,"yyyy-MM-dd hh:mm:ss"),X=p(j,"yyyy-MM-dd hh:mm:ss"),Y=p(K,"yyyy-MM-dd hh:mm:ss");return r.extend(T,{statusName:J,startName:Q,endName:X,createName:Y}),T}),e.list=E.reverse()}else y.proxy.$toast({icon:"error",text:`Error: ${c} ${F}`})})}return w(),(i,a)=>{const g=G("VDatePicker");return m(),f("div",gt,[t("div",ht,[t("ul",yt,[t("li",vt,[M(g,{modelValue:o(e).range,"onUpdate:modelValue":a[0]||(a[0]=s=>o(e).range=s),modelModifiers:{range:!0}},{default:V(({togglePopover:s})=>[t("div",{class:"form-control cim-as-date-content",onClick:s},d(p(o(e).range.start))+" 至 "+d(p(o(e).range.end)),9,bt)]),_:1},8,["modelValue"])]),t("li",kt,[D(t("input",{class:"form-control",type:"text","onUpdate:modelValue":a[1]||(a[1]=s=>o(e).params.user_id=s),placeholder:"用户 ID",autocomplete:"off",onKeydown:U(_,["enter"])},null,544),[[S,o(e).params.user_id]])]),t("li",wt,[D(t("input",{class:"form-control",type:"text","onUpdate:modelValue":a[2]||(a[2]=s=>o(e).params.description=s),placeholder:"备注信息",autocomplete:"off",onKeydown:U(_,["enter"])},null,544),[[S,o(e).params.description]])]),t("li",{class:"cim-log-lf-item"},[t("div",{class:"cim-button cim-button-bg",onClick:_},"查询")])]),t("ul",$t,[t("li",xt,[t("div",{class:"cim-button cim-button-bg cim-button-green",onClick:a[3]||(a[3]=s=>k(!0))},"拉取日志")])])]),t("div",Dt,[t("table",Ct,[a[5]||(a[5]=t("thead",null,[t("tr",null,[t("th",{class:"cim-td-c"},"用户 ID"),t("th",{class:"cim-td-c"},"平台"),t("th",{class:"cim-td-c"},"收集时间"),t("th",{class:"cim-td-c"},"拉取时间"),t("th",{class:"cim-td-c"},"日志状态"),t("th",{class:"cim-td-c"},"日志备注"),t("th",{class:"cim-td-c"},"操作")])],-1)),t("tbody",null,[(m(!0),f(B,null,I(o(e).list,s=>(m(),f("tr",null,[t("td",St,d(s.user_id),1),t("td",Et,d(s.platform),1),t("td",Tt,d(s.startName)+" 至 "+d(s.endName),1),t("td",Lt,d(s.createName),1),t("td",Pt,[t("span",{class:at(["cicon cim-log-status",["cicon-status-"+s.state]])},d(s.statusName),3)]),t("td",Vt,d(s.description),1),t("td",Mt,[t("ul",Nt,[o(r).isEqual(s.state,o(R).COMPLETE)?(m(),f("li",Ut,[s.log_url?(m(),f("a",{key:0,class:"btn-link",href:s.log_url},"下载",8,Ot)):(m(),f("a",{key:1,class:"btn-link",href:"#",onClick:c=>n(s)},"下载",8,Rt))])):L("",!0)])])]))),256))])])]),t("div",qt,[t("nav",At,[t("ul",Gt,[o(e).params.offset>1?(m(),f("li",It,[t("a",{class:"page-link",href:"#","aria-label":"Previous",onClick:x},a[6]||(a[6]=[t("span",{"aria-hidden":"true"},"上一页",-1)]))])):L("",!0),t("li",Bt,[o(e).list.length>=o(e).params.limit?(m(),f("a",{key:0,class:"page-link",href:"#","aria-label":"Next",onClick:l},a[7]||(a[7]=[t("span",{"aria-hidden":"true"},"下一页",-1)]))):L("",!0)])])])]),M(_t,{show:o(e).isShowPullDialog,title:"拉取日志",text:"确定",type:o(e).dialogType,onHide:a[4]||(a[4]=s=>k(!1)),onSave:$},null,8,["show","type"])])}}};export{Ft as default};
